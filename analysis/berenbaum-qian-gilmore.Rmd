---
title: "Analyses for Berenbaum, Qian, & Gilmore"
author: "Yiming Qian & Rick Gilmore"
date: "`r Sys.time()`"
output: 
  html_document:
    self_contained: false
    code_folding: hide
    toc: true
    toc_depth: 2
    toc_float: true
params:
  data_path: "csv"
  csv_fn: "combined_2021-08-26.csv"
  outlier_sd_thresh: 3.0
  plot_device: "png"
---

# Purpose

This document shows our analyses following a plan we preregistered here:

https://aspredicted.org/5iv9a.pdf

It also shows a series of analyses that were not preregistered.

# Setup

Set chunk options and load libraries.

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  fig.path = "img/",
  dev = params$plot_device,
  dpi = 300,
  fig.align = "center",
  fig.width = 7,
  fig.height = 5
)

library(tidyverse)
library(Hmisc)
library(ggExtra)
library(add2ggplot)
library(gridExtra)
```



# Import data

Data from the set of tasks were merged and cleaned as described in `import-clean-raw-data.Rmd`.

```{r load}
sex_diff_df <- readr::read_csv(file.path(params$data_path, params$csv_fn)) 
```



# Preregistered analyses

## Individual measures

### Visual perception thresholds

> An average threshold for each participant will be calculated across 4 runs for each visual perception task. If necessary, we will transform the psychophysical thresholds to make the distributions symmetric and appropriate for parametric analyses.

In the analyses below, we use the median threshold across the four runs. 

The distribution of median thresholds is skewed, as indicated in the figures below:

```{r, contrast-hist}
sex_diff_df %>%
  ggplot(.) +
  aes(x = contrast_thr) +
  geom_histogram()
```

```{r, motion-hist}
sex_diff_df %>%
  ggplot(.) +
  aes(x = motion_dur_thr) +
  geom_histogram()
```

So, we use a log transformation.

```{r}
sex_diff_df <- sex_diff_df %>%
  dplyr::mutate(.,
                log_contrast = log(contrast_thr),
                log_motion = log(motion_dur_thr))
```

> To examine sex differences, one-tailed t tests will be conducted to compare men and women on 2 visual perception thresholds, spatial ability, and masculine hobbies. We will use verbal ability as our control variable. We set a family-wise Type I error rate at alpha=0.05. Because there are four dependent variables hypothesized to show sex differences, the critical p value for each sex comparison is 0.0125 after Bonferroni correction. Our goal is to obtain .8 power to detect a medium effect size of .5 (Cohenâ€™s d) at the p value of .0125 in the one-tailed t tests. Unequal sample sizes of the two sexes may be collected in this study.

#### Contrast thresholds

```{r}
df_contrast <- sex_diff_df %>%
  dplyr::filter(., !is.na(log_contrast)) %>%
  dplyr::select(., Sex, log_contrast)
xtabs(~ Sex, df_contrast)
```

```{r}
sex_diff_df %>%
  ggplot() +
  aes(Sex, log_contrast) +
  geom_boxplot()
```

We then test for a difference in means.

```{r}
cst_tt <-
  t.test(
    log_contrast ~ Sex,
    data = sex_diff_df,
    var.equal = TRUE,
    alternative = "greater"
  ) # Hypothesized
cst_tt
```

Median log(contrast) thresholds are lower in women than men This means that women had larger contrast thresholds or were less sensitive to contrast.

This can be seen in a plot in the original threshold units.

```{r}
sex_diff_df %>%
  ggplot() +
  aes(Sex, contrast_thr) +
  geom_boxplot()
```

We use the `esvis` package to compute the Hedge's G effect size measure since the groups have unequal means.

```{r contrast-eff-size}
esvis::hedg_g(sex_diff_df, log_contrast ~ Sex)
```

In order to compute a confidence interval for the effect size, we use the `esci` package. We have already installed the package, so we set the following chunk to `eval=FALSE`.

```{r, eval=FALSE}
devtools::install_github("rcalinjageman/esci")
```

```{r}
sex_diff_df$Sex.factor <- as.factor(sex_diff_df$Sex)

es_log_contrast <- esci::estimateMeanDifference.default(sex_diff_df,
                                     Sex.factor,
                                     log_contrast,
                                     paired = FALSE,
                                     var.equal = TRUE,
                                     conf.level = .95)
#es_log_contrast
```

`r es_log_contrast$formatted_d`

#### Motion duration thresholds

```{r}
df_motion <- sex_diff_df %>%
  dplyr::filter(., !is.na(log_motion)) %>%
  dplyr::select(., Sex, log_motion)
xtabs(~ Sex, df_motion)
```


```{r}
sex_diff_df %>%
  ggplot() +
  aes(Sex, log_motion) +
  geom_boxplot()
```

We then test for a difference in means.

```{r}
mdt_tt <-
  t.test(
    log_motion ~ Sex,
    data = sex_diff_df,
    var.equal = TRUE,
    alternative = "greater"
  ) # Hypothesized
mdt_tt
```

Median log(motion duration) thresholds are larger in women than men This means that women were less sensitive to motion.

This can be seen in a plot in the original threshold units.

```{r}
sex_diff_df %>%
  ggplot() +
  aes(Sex, motion_dur_thr) +
  geom_boxplot()
```

```{r motion-eff-size}
esvis::hedg_g(sex_diff_df, log_motion ~ Sex)
```

Using `esci` to calculate a CI:

```{r}
es_log_motion <- esci::estimateMeanDifference.default(sex_diff_df,
                                     Sex.factor,
                                     log_motion,
                                     paired = FALSE,
                                     var.equal = TRUE,
                                     conf.level = .95)
#es_log_motion
```

`r es_log_motion$formatted_d`

### Spatial ability

Our measure of spatial ability is performance on a mental rotation task.

```{r}
df_mental_rot <- sex_diff_df %>%
  dplyr::filter(., !is.na(mental_rot)) %>%
  dplyr::select(., Sex, mental_rot)
xtabs(~ Sex, df_mental_rot)
```


```{r}
sex_diff_df %>%
  ggplot() +
  aes(Sex, mental_rot) +
  geom_boxplot()
```

We test for a difference in means.

```{r}
mr_tt <-
  t.test(
    mental_rot ~ Sex,
    data = sex_diff_df,
    var.equal = TRUE,
    alternative = "less"
  ) # Hypothesized
mr_tt
```

Women had fewer correct trials than men. This is shown by the effect size.

```{r mental-rot-eff-size}
esvis::hedg_g(sex_diff_df, mental_rot ~ Sex)
```

Using `esci` to calculate CIs.

```{r}
es_mental_rot <- esci::estimateMeanDifference.default(sex_diff_df,
                                     Sex.factor,
                                     mental_rot,
                                     paired = FALSE,
                                     var.equal = TRUE,
                                     conf.level = .95)
#es_mental_rot
```

`r es_mental_rot$formatted_d`.

### Male-typed hobbies

```{r}
df_m_hobbies <- sex_diff_df %>%
  dplyr::filter(., !is.na(Masculine_hobbies)) %>%
  dplyr::select(., Sex, Masculine_hobbies)
xtabs(~ Sex, df_m_hobbies)
```


```{r}
sex_diff_df %>%
  ggplot() +
  aes(Sex, Masculine_hobbies) +
  geom_boxplot()
```

We test for a difference in means.

```{r}
mr_tt <-
  t.test(
    Masculine_hobbies ~ Sex,
    data = sex_diff_df,
    var.equal = TRUE,
    alternative = "less"
  )   # Hypothesized
mr_tt
```


```{r m-hobbies-eff-size}
esvis::hedg_g(sex_diff_df, Masculine_hobbies ~ Sex)
```

Using `esci` to calculate CIs.

```{r}
es_m_hobbies <- esci::estimateMeanDifference.default(sex_diff_df,
                                     Sex.factor,
                                     Masculine_hobbies,
                                     paired = FALSE,
                                     var.equal = TRUE,
                                     conf.level = .95)
#es_m_hobbies
```

`r es_m_hobbies$formatted_d`.

### Verbal ability

We predicted no sex difference in verbal ability as measured by vocabulary size.

```{r}
sex_diff_df %>%
  ggplot() +
  aes(Sex, Masculine_hobbies) +
  geom_boxplot()
```

We test for a difference in means.

```{r}
vocab_tt <-
  t.test(
    vocab ~ Sex,
    data = sex_diff_df,
    var.equal = TRUE,
    alternative = "two.sided"
  ) # Hypothesized
vocab_tt
```

We find no statistically significant difference in vocabulary scores.

This is also shown by the effect size.

```{r vocab-eff-size}
esvis::hedg_g(sex_diff_df, vocab ~ Sex)
```


```{r}
es_vocab <- esci::estimateMeanDifference.default(sex_diff_df,
                                     Sex.factor,
                                     vocab,
                                     paired = FALSE,
                                     var.equal = TRUE,
                                     conf.level = .95)
#es_vocab
```

`r es_m_hobbies$formatted_d`.

#### get the mean and sd

```{r}
df_mental_rot %>% 
  group_by(Sex) %>% 
  summarise(mean=mean(mental_rot,na.rm=T),sd=sd(mental_rot,na.rm=T))%>% 
  mutate_if(is.numeric, format, 2)

sex_diff_df %>% 
  group_by(Sex) %>% 
  summarise(mean=mean(vocab,na.rm=T),sd=sd(vocab,na.rm=T))%>% 
  mutate_if(is.numeric, format, 2)

sex_diff_df %>% 
  group_by(Sex) %>% 
  summarise(mean=mean(Masculine_hobbies,na.rm=T),sd=sd(Masculine_hobbies,na.rm=T))%>% 
  mutate_if(is.numeric, format, 2)
```

## Correlations among measures

> To examine how individual differences of visual perception measures are associated with other tasks, we will use correlations within sex. The lower visual perception threshold is, the higher perceptual sensitivity this individual has. In both sexes, we expect to find negative correlations between visual perception measures and spatial ability and masculine hobbies, but no significant correlation with verbal ability. There are four planned correlations (two visual perception tasks times two cognitive tasks) within sex, for a total of eight. This project is a novel study that has not to our knowledge been conducted previously. So we have consciously decided to maintain strict control of Type II error, in order to have enough statistical power to detect a small correlation effect sizes (r=0.20) within the constraints of sample size. This decision to maximize the power (.80) leads to a trade-off between Type I and Type II error. We plan to conduct eight separate one-tailed correlation tests with Type I error at 0.05 and no Bonferroni correction. With a critical p value of .05, around 150 participants are required for each group to detect an effect size of 0.20 at an obtained power of 0.8 with a one-tailed correlation test.

We create two data frames by participant sex.

```{r}
sex_diff_df_F <- sex_diff_df %>%
  dplyr::filter(., Sex == "Female") %>%
  dplyr::select( 
                log_contrast,
                log_motion,
                mental_rot,
                vocab,
                Masculine_hobbies,
                masscale
               )
```

```{r}
sex_diff_df_M <- sex_diff_df %>%
  dplyr::filter(., Sex == "Male") %>%
  dplyr::select( 
                log_contrast,
                log_motion,
                mental_rot,
                vocab,
               Masculine_hobbies,
                masscale
               )
```

### Contrast thresholds and mental rotation

#### Women

```{r}
cor.test(
  sex_diff_df_F$log_contrast,
  sex_diff_df_F$mental_rot,
  method = "pearson",
  alternative = "less"
)
```

Contrast thresholds (negatively) correlate with mental rotation scores in women The negative correlation means that smaller log(contrast) values or higher contrast sensitivity is associated with better performance in the mental rotation task.

We can use `esci` to provide CIs for this estimate.

```{r}
es_mental_rot_contrast <- esci::estimateCorrelation.default(sex_diff_df_F, log_contrast, mental_rot)
#es_mental_rot_contrast
```

We estimate the correlation between mental_rotation and log contrast thresholds in women as follows: `r es_mental_rot_contrast$formatted_r`.

#### Men

```{r}
cor.test(
  sex_diff_df_M$log_contrast,
  sex_diff_df_M$mental_rot,
  method = "pearson",
  alternative = "less"
)
```

Contrast thresholds do not significantly correlate with mental rotation scores in men. 

We can use `esci` to provide CIs for this estimate.

```{r}
es_mental_rot_contrast <- esci::estimateCorrelation.default(sex_diff_df_M, log_contrast, mental_rot)
#es_mental_rot_contrast
```

We estimate the correlation between mental_rotation and log contrast thresholds in men as follows: `r es_mental_rot_contrast$formatted_r`.

### Motion thresholds and mental rotation

#### Women

```{r}
cor.test(
  sex_diff_df_F$log_motion,
  sex_diff_df_F$mental_rot,
  method = "pearson",
  alternative = "less"
)
```

Log(motion duration) thresholds (negatively) correlate with mental rotation scores in women This means that lower thresholds (higher sensitivity) is associated with better performance in the mental rotation task.

We can use `esci` to provide CIs for this estimate.

```{r}
es_mental_rot_motion <- esci::estimateCorrelation.default(sex_diff_df_F, log_motion, mental_rot)
#es_mental_rot_motion
```

We estimate the correlation between mental_rotateion and log motion thresholds in women as follows: `r es_mental_rot_motion$formatted_r`.

#### Men

```{r}
cor.test(
  sex_diff_df_M$log_motion,
  sex_diff_df_M$mental_rot,
  method = "pearson",
  alternative = "less"
)
```

Motion duration thresholds do not significantly correlate with mental rotation scores in men.

We can use `esci` to provide CIs for this estimate.

```{r}
es_mental_rot_motion <- esci::estimateCorrelation.default(sex_diff_df_M, log_motion, mental_rot)
#es_mental_rot_motion
```

We estimate the correlation between mental_rotation and log motion thresholds in men as follows: `r es_mental_rot_motion$formatted_r`

### Contrast thresholds and male-typed activities

#### Women

```{r}
cor.test(
  sex_diff_df_F$Masculine_hobbies,
  sex_diff_df_F$log_contrast,
  method = "pearson",
  alternative = "less"
)
```

```{r}
es_contrast_m_hobbies <- esci::estimateCorrelation.default(sex_diff_df_F, Masculine_hobbies, log_contrast)
#es_contrast_m_hobbies 
```

We estimate the correlation between log contrast and interest in male-typed activities in women as follows: `r es_contrast_m_hobbies$formatted_r`

#### Men

```{r}
cor.test(
  sex_diff_df_M$Masculine_hobbies,
  sex_diff_df_M$log_contrast,
  method = "pearson",
  alternative = "less"
)
```

```{r}
es_contrast_m_hobbies <- esci::estimateCorrelation.default(sex_diff_df_M, Masculine_hobbies, log_contrast)
#es_contrast_m_hobbies
```

We estimate the correlation between mental_rotation and interest in male-typed activities in men as follows: `r es_contrast_m_hobbies$formatted_r`

### Motion thresholds and male-typed activities

#### Women

```{r}
cor.test(
  sex_diff_df_F$Masculine_hobbies,
  sex_diff_df_F$log_motion,
  method = "pearson",
  alternative = "less"
)
```

```{r}
es_motion_m_hobbies <- esci::estimateCorrelation.default(sex_diff_df_F, Masculine_hobbies, log_motion)
#es_motion_m_hobbies
```

We estimate the correlation between log motion and interest in male-typed activities in women as follows: `r es_motion_m_hobbies$formatted_r`

#### Men

```{r}
cor.test(
  sex_diff_df_M$Masculine_hobbies,
  sex_diff_df_M$log_motion,
  method = "pearson",
  alternative = "less"
)
```

```{r}
es_motion_m_hobbies <- esci::estimateCorrelation.default(sex_diff_df_M, Masculine_hobbies, log_motion)
#es_mental_rot_motion
```

We estimate the correlation between mental_rotation and interest in male-typed activities in men as follows: `r es_motion_m_hobbies$formatted_r`

### Contrast thresholds and motion thresholds

#### Women

```{r}
cor.test(
  sex_diff_df_F$log_contrast,
  sex_diff_df_F$log_motion,
  method = "pearson",
  alternative = "greater"
)
```

The vision measures do not correlate in women.

We can use `esci` to provide CIs for this estimate.

```{r}
es_contrast_motion <- esci::estimateCorrelation.default(sex_diff_df_F, log_contrast, log_motion)
#es_contrast_motion
```

We estimate the correlation between log contrast and log motion thresholds in women as follows: `r es_contrast_motion$formatted_r`.

#### Men

```{r}
cor.test(
  sex_diff_df_M$log_contrast,
  sex_diff_df_M$log_motion,
  method = "pearson",
  alternative = "greater"
)
```

The vision measures correlate in men.

We can use `esci` to provide CIs for this estimate.

```{r}
es_contrast_motion <- esci::estimateCorrelation.default(sex_diff_df_M, log_contrast, log_motion)
#es_contrast_motion
```

We estimate the correlation between log contrast and log motion thresholds in men as follows: `r es_contrast_motion$formatted_r`.


### Male-typed activities and mental rotation

We did not preregister this analysis.

#### Women

```{r}
cor.test(
  sex_diff_df_F$Masculine_hobbies,
  sex_diff_df_F$mental_rot,
  method = "pearson",
  alternative = "less"
)
```

```{r}
es_mental_rot_m_hobbies <- esci::estimateCorrelation.default(sex_diff_df_F, Masculine_hobbies, mental_rot)
#es_mental_rot_motion
```

We estimate the correlation between mental rotation and interest in male-typed activities in women as follows: `r es_mental_rot_m_hobbies$formatted_r`

#### Men

```{r}
cor.test(
  sex_diff_df_M$Masculine_hobbies,
  sex_diff_df_M$mental_rot,
  method = "pearson",
  alternative = "less"
)
```

```{r}
es_mental_rot_m_hobbies <- esci::estimateCorrelation.default(sex_diff_df_M, Masculine_hobbies, mental_rot)
#es_mental_rot_motion
```

We estimate the correlation between mental_rotation and interest in male-typed activities in women as follows: `r es_mental_rot_m_hobbies$formatted_r`

## Visualizations

```{r ggplot-themes}
# "The APA has determined specifications for the size of figures and the fonts used in them. Figures of one column must be between 2 and 3.25 inches wide (5 to 8.45 cm). Two-column figures must be between 4.25 and 6.875 inches wide (10.6 to 17.5 cm). The height of figures should not exceed the top and bottom margins. The text in a figure should be in a san serif font (such as Helvetica, Arial, or Futura). The font size must be between eight and fourteen point. Use circles and squares to distinguish curves on a line graph (at the same font size as the other labels). "
theme.custom <- theme(panel.background = element_rect(fill = "white", colour = "grey50"),
                      plot.title = element_text(size=24, face="bold",hjust = 0.5),
                      axis.title.x = element_text(size=24),
                      axis.title.y = element_text(size=24),
                      strip.text = element_text(size=24),
                      axis.text = element_text(size=24),
                      legend.position = "bottom",
               #   legend.position = "topleft",
                       legend.title = element_blank(),
#  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                      legend.text=element_text(size=24))
```

The following scatterplots are formatted so that higher sensitivity on the visual tasks (lower log thresholds) are to the right.

```{r}
sex_diff_scatter <-
  function(df,
           x_var,
           y_var,
           x_rev = FALSE,
           y_rev = FALSE,
           an_f = "",
           an_m = "",
           anx = NULL,
           any = NULL,
           x_lab = "X axis",
           y_lab = "Y axis",
           square_axis = TRUE,
           margin_type = "boxplot"
           ) {
    require(tidyverse)
    require(ggExtra)
    
    x_var_s <- sym(x_var)
    y_var_s <- sym(y_var)
    
    p <- ggplot(df) +
      aes(
        x = !!x_var_s,
        y = !!y_var_s,
        group = Sex,
        color = Sex
      ) +
      geom_point(size=4) +
      xlab(x_var) +
      ylab(y_var) +
      stat_smooth(method = "lm", na.rm = TRUE) +
      xlab(x_lab) +
      ylab(y_lab)+
      theme.custom +
      scale_colour_grey(start=0,end=0.5) +
     annotate(
        "text",
        x = anx,
        y = any,
        size=8,
        label = c(an_f, an_m), color=gray.colors(2, start = 0, end = 0.5),
             hjust = 1
      ) 
    
    if (square_axis)
    {
      p + coord_fixed() + theme(asp.ratio = 1)
    }
    
    if (stringr::str_detect(x_var, 'hobbies')) {
      p <- p + xlim(1, 5)
    }
    if (stringr::str_detect(y_var, 'hobbies')) {
      p <- p + ylim(1, 5)
    }
    
    # Reverse scale for threshold measures?
    if (x_rev)
      p <- p + scale_x_reverse()
    if (y_rev)
      p <- p + scale_y_reverse()
    
    p1 <- ggExtra::ggMarginal(p,
                              type = margin_type,
                              margins = "both",
                              groupFill = TRUE)
    p1
  }
```

Create matrices of correlation coefficients for subsequent plotting.

```{r}
corr_vars <- c('log_contrast', 'log_motion', 'mental_rot', 'Masculine_hobbies')
df_corr_F <- sex_diff_df_F %>%
  dplyr::select(., corr_vars)

corr_F <- Hmisc::rcorr(as.matrix(df_corr_F), type = c("pearson"))

df_corr_M <- sex_diff_df_M %>%
  dplyr::select(., corr_vars)

corr_M <- Hmisc::rcorr(as.matrix(df_corr_M), type = c("pearson"))

df_corr_all <- sex_diff_df %>%
  dplyr::select(., corr_vars)

corr_all <- Hmisc::rcorr(as.matrix(df_corr_all), type = c("pearson"))
```

Create a helper function to generate and plot correlation coefficients.

```{r sex-diff-corr-sum-function}
sex_diff_corr_summ <- function(x_var, y_var, print_table = TRUE, 
                               corr_all_df = corr_all,
                               corr_M_df = corr_M,
                               corr_F_df = corr_F,
                               show_combined = FALSE) {
  require(tidyverse) # for %>%
  
  corr_all_df <- tibble::tibble(
    cor_coef = corr_all_df$r[x_var, y_var],
    p_val = corr_all_df$P[x_var, y_var],
    n =  corr_all_df$n[x_var, y_var],
    pop = "Both"
  )
  males_df <- tibble::tibble(
    cor_coef = corr_M_df$r[x_var, y_var],
    p_val = corr_M_df$P[x_var, y_var],
    n =  corr_M_df$n[x_var, y_var],
    pop = "Males"
  )
  
  females_df <- tibble::tibble(
    cor_coef = corr_F_df$r[x_var, y_var],
    p_val = corr_F_df$P[x_var, y_var],
    n =  corr_F_df$n[x_var, y_var],
    pop = "Females"
  )
  
  if (show_combined) {
    df <- rbind(corr_all_df, males_df, females_df)
  } else {
    df <- rbind(males_df, females_df)
  }
  
  # Add stars for significance levels
  df <- df %>%
    mutate(., stars = if_else(p_val < .005, "***",
                              if_else(
                                p_val < .01, "**",
                                if_else(p_val < .05, "*", " ns")
                              )))
  
  if (print_table) {
    kableExtra::kable(df, format = 'html') %>%
      kableExtra::kable_styling()
  } else {
    df
  }
}
```

### Contrast sensitivity & mental rotation

```{r contrast-sens-mental-rot}
corr_df <- sex_diff_corr_summ("log_contrast", "mental_rot",
                              corr_all,
                              corr_M_df = corr_M,
                              corr_F_df = corr_F,
                              print_table = FALSE)

p1<-sex_diff_scatter(
  sex_diff_df,
  "log_contrast",
  "mental_rot",
  x_rev = FALSE,
  y_rev = FALSE,
  paste0(
    "r = ",
    format(corr_df$cor_coef[2], digits = 2, nsmall = 2),
    corr_df$stars[2]
  ),
  paste0(
    "r = ",
    format(corr_df$cor_coef[1], digits = 2, nsmall = 2),
    corr_df$stars[1]
  ),
  c(-1.2),
  c(12, 38),
  "log(contrast threshold)",
  "Mental rotation score"
)
p1
sex_diff_corr_summ("log_contrast", "mental_rot")
```

### Motion sensitivity & mental rotation

```{r}
sex_diff_scatter_2 <-
  function(df,
           x_var,
           y_var,
           x_rev = FALSE,
           y_rev = FALSE,
           an_f = "",
           an_m = "",
           anx = NULL,
           any = NULL,
           x_lab = "X axis",
           y_lab = "Y axis",
           square_axis = TRUE,
           margin_type = "boxplot") {
    require(tidyverse)
    require(ggExtra)
    
    x_var_s <- sym(x_var)
    y_var_s <- sym(y_var)
    
    p <- ggplot(df) +
      aes(
        x = !!x_var_s,
        y = !!y_var_s,
        group = Sex,
        color = Sex
      ) +
      geom_point(size=4) +
      xlab(x_var) +
      ylab(y_var) +
      stat_smooth(method = "lm", na.rm = TRUE) +
     theme.custom +
      xlab(x_lab) +
      ylab(y_lab) +
      scale_colour_grey(start=0,end=0.5)+
      annotate(
        "text",
        x = anx,
        y = any,
        size=8,
        label = c(an_f, an_m), color=gray.colors(2, start = 0, end = 0.5),
             hjust = 1
      )

    # if (show_corr_vals) {
    #   p + annotate(
    #     "text",
    #     x = anx,
    #     y = any,
    #     label = c(an_f, an_m),
    #     color = c('red', 'darkturquoise')
    #   )
    # }
    # 
    # if (square_axis)
    # {
    #   p + coord_fixed() + theme(asp.ratio = 1)
    # }
    # 
    # if (stringr::str_detect(x_var, 'hobbies')) {
    #   p <- p + xlim(1, 5)
    # }
    # if (stringr::str_detect(y_var, 'hobbies')) {
    #   p <- p + ylim(1, 5)
    # }
    # 
    # # Reverse scale for threshold measures?
    # if (x_rev)
    #   p <- p + scale_x_reverse()
    # if (y_rev)
    #   p <- p + scale_y_reverse()
    # 
    # p1 <- ggExtra::ggMarginal(p,
    #                           type = margin_type,
    #                           margins = "both",
    #                           groupFill = TRUE)
    p
  }
```


```{r motion-duration-mental-rot-annotate-outliers}
corr_df <- sex_diff_corr_summ("log_motion",
                              "mental_rot", print_table = FALSE)

p_motion <- sex_diff_scatter_2(
  sex_diff_df,
  "log_motion",
  "mental_rot",
  x_rev = FALSE,
  y_rev = FALSE,
  paste0(
    "r = ",
    format(corr_df$cor_coef[2], digits = 2, nsmall = 2),
    corr_df$stars[2]
  ),
  paste0(
    "r = ",
    format(corr_df$cor_coef[1], digits = 2, nsmall = 2),
    corr_df$stars[1]
  ),
  c(-0.9),
  c(12, 38),
  "log(motion threshold)",
  "Mental rotation score"
)

# p_motion <- sex_diff_scatter(
#   sex_diff_df,
#   "log_motion",
#   "mental_rot",
#   x_rev = FALSE,
#   y_rev = FALSE,
#   paste0(
#     "r = ",
#     format(corr_df$cor_coef[3], digits = 2, nsmall = 2),
#     corr_df$stars[3]
#   ),
#   paste0(
#     "r = ",
#     format(corr_df$cor_coef[2], digits = 2, nsmall = 2),
#     corr_df$stars[2]
#   ),
#   c(-1.8,-1.9),
#   c(30, 36),
#   "log(motion threshold)",
#   "Mental rotation score"
# )

p_aug <- p_motion +
  ggplot2::annotate(
    geom = "point",
    x = sex_diff_df$log_motion[c(125, 128)],
    y = sex_diff_df$mental_rot[c(125, 128)],
    color = "black",
    size = 8,
    shape = 0
  )

p_aug <- ggExtra::ggMarginal(p_aug,
                             type = "boxplot",
                             margins = "both",
                             groupFill = TRUE)

p_aug

sex_diff_corr_summ("log_motion", "mental_rot")
```

### Contrast sensitivity & male-typed interests

```{r contrast-sens-male-hobbies}
corr_df <- sex_diff_corr_summ("log_contrast", "Masculine_hobbies",
                              corr_all,
                              corr_M_df = corr_M,
                              corr_F_df = corr_F,
                              print_table = FALSE)

p3<-sex_diff_scatter(
  sex_diff_df,
  "log_contrast",
  "Masculine_hobbies",
  x_rev = FALSE,
  y_rev = FALSE,
  paste0(
    "r = ",
    format(corr_df$cor_coef[2], digits = 2, nsmall = 2),
    corr_df$stars[2]
  ),
  paste0(
    "r = ",
    format(corr_df$cor_coef[1], digits = 2, nsmall = 2),
    corr_df$stars[1]
  ),
  c(-1.2),
  c(1.2, 4.8),
  "log(contrast threshold)",
  "Interest in male-typed activities"
)
p3

sex_diff_corr_summ("log_contrast", "Masculine_hobbies")
```

### Motion sensitivity & contrast sensitivity

```{r motion-duration-contrast-sens}
corr_df <- sex_diff_corr_summ("log_motion",
                              "log_contrast", print_table = FALSE)

p_vision<-sex_diff_scatter_2(
  sex_diff_df,
  "log_motion",
  "log_contrast",
  x_rev = FALSE,
  y_rev = FALSE,
  paste0(
    "r = ",
    format(corr_df$cor_coef[2], digits = 2, nsmall = 2),
    corr_df$stars[2]
  ),
  paste0(
    "r = ",
    format(corr_df$cor_coef[1], digits = 2, nsmall = 2),
    corr_df$stars[1]
  ),
  c(-0.8),
  c(-1.96,-1.3),
  "log(motion threshold)",
  "log(contrast threshold)"
)

p_aug2 <- p_vision +
  ggplot2::annotate(
    geom = "point",
    x = sex_diff_df$log_motion[c(125, 128)],
    y = sex_diff_df$log_contrast[c(125, 128)],
    color = "black",
    size = 8,
    shape = 0
  )

p_aug2 <- ggExtra::ggMarginal(p_aug2,
                             type = "boxplot",
                             margins = "both",
                             groupFill = TRUE)

p_aug2

sex_diff_corr_summ("log_motion",
                   "log_contrast")
```

```{r}
library("gridExtra")
p = grid.arrange(ncol = 2, nrow = 2, p1, p_aug, p3,p_aug2)
ggsave(
  plot = p,
  filename = paste0("~/Desktop/fig1.png"),
  units = "in",
  height = 12,
  width = 12,
  dpi = 600
)
```



# Non-pregistered analyses

## Does vision account for mental rotation?

There are two approaches to answering this question.
One looks for sex differences in the residuals of the models `mental rotation ~ contrast` and `mental rotation ~ motion`.
The other models `mental rotation ~ contrast + sex + contrast:sex` and determines whether adding the `sex` term provides a better fit relative to `mental rotation ~ contrast` alone. 

### Residuals-based approach

We'll take evaluate the first approach using residuals.

#### Contrast

Focus on the log contrast sensitivity threshold data.

```{r}
# Select relevant data from data frame.
df_mr_log_contr <- sex_diff_df %>%
  dplyr::select(., Sex, log_contrast, mental_rot) %>%
  dplyr::filter(., !is.na(Sex),
                !is.na(log_contrast),
                !is.na(mental_rot))
```

Visualize mental rotation scores.

```{r}
df_mr_log_contr %>%
  ggplot(.) +
  aes(Sex, mental_rot, color = Sex, alpha = 0.3) +
  geom_boxplot() +
  geom_violin() +
  geom_point() +
  theme(legend.position = "none")
```

```{r}
t.test(
  mental_rot ~ Sex,
  data = sex_diff_df,
  var.equal = TRUE,
  alternative = "less"
)
```

Mental rotation scores differ between men and women.

Fit `mental_rot ~ log_contrast`.

```{r}
lm_mr_log_contr <- lm(mental_rot ~ log_contrast, df_mr_log_contr)
summary(lm_mr_log_contr)
```

Extract the residuals and fit `mr_resids ~ Sex`.

```{r}
resids <- resid(lm_mr_log_contr)
df_mr_resids <- data.frame(mr_resids = resids, Sex = df_mr_log_contr$Sex)
lm_mr_resids_sex <- lm(mr_resids ~ Sex, df_mr_resids)
summary(lm_mr_resids_sex)
```

Plot to visualize.

```{r}
df_mr_resids %>%
  ggplot(.) +
  aes(Sex, mr_resids, color = Sex, alpha = 0.3) +
  geom_boxplot() +
  geom_violin() +
  geom_point() +
  theme(legend.position = "none")
```

Test for differences in means.

```{r}
t.test(
  mr_resids ~ Sex,
  data = df_mr_resids,
  var.equal = TRUE,
  alternative = "less"
)
```

So, including contrast sensitivity reduces, but does not eliminate, a statistically significant difference in mental rotation scores by sex favoring men.

#### Motion

```{r}
# Select relevant data from data frame.
df_mr_log_motion <- sex_diff_df %>%
  dplyr::select(., Sex, log_motion, mental_rot) %>%
  dplyr::filter(., !is.na(Sex),
                !is.na(log_motion),
                !is.na(mental_rot))
```

Fit `mental_rot ~ log_cmotion`.

```{r}
lm_mr_log_motion <- lm(mental_rot ~ log_motion, df_mr_log_motion)
summary(lm_mr_log_motion)
```

Extract the residuals and fit `mr_resids ~ Sex`.

```{r}
resids <- resid(lm_mr_log_motion)
df_mr_resids <- data.frame(mr_resids = resids, Sex = df_mr_log_motion$Sex)
lm_mr_resids_sex <- lm(mr_resids ~ Sex, df_mr_resids)
summary(lm_mr_resids_sex)
```

Plot to visualize.

```{r}
df_mr_resids %>%
  ggplot(.) +
  aes(Sex, mr_resids, color = Sex, alpha = 0.3) +
  geom_boxplot() +
  geom_violin() +
  geom_point() +
  theme(legend.position = "none")
```

Test for mean differences.

```{r}
t.test(
  mr_resids ~ Sex,
  data = df_mr_resids,
  var.equal = TRUE,
  alternative = "less"
)
```

So, including motion reduces but does not eliminate a statistically significant difference in mental rotation scores by sex favoring men.

### Model-based approach

Let's see whether combining the vision measures can do even better in accounting for mental rotation.

```{r}
df_mr_contr_motion <- sex_diff_df %>%
  dplyr::select(., Sex, log_contrast, log_motion, mental_rot) %>%
  dplyr::filter(., !is.na(Sex),
                !is.na(log_contrast),
                !is.na(log_motion),
                !is.na(mental_rot))
```

Full model.

```{r}
lm_mr_contr_motion_full <- lm(mental_rot ~ log_contrast*log_motion*Sex, data = df_mr_contr_motion)
summary(lm_mr_contr_motion_full)
```

Drop interactions.

```{r}
lm_mr_contr_motion_no_interactions <- lm(mental_rot ~ log_contrast + log_motion + Sex, data = df_mr_contr_motion)
summary(lm_mr_contr_motion_no_interactions)
```

Drop sex.

```{r}
lm_mr_contr_motion_no_sex <- lm(mental_rot ~ log_contrast + log_motion, data = df_mr_contr_motion)
summary(lm_mr_contr_motion_no_sex)
anova(lm_mr_contr_motion_no_sex)
```

Compare models.

```{r}
anova(lm_mr_contr_motion_no_sex, lm_mr_contr_motion_no_interactions)
```

So, the RSS drops a bit, but not significantly. All things being equal, we'd choose the simpler model for parsimony reasons.

Here's a model with sex alone.

```{r}
lm_mr_only_sex <- lm(mental_rot ~ Sex, data = df_mr_contr_motion)
summary(lm_mr_only_sex)
```

Comparing this to one with vision but not sex.

```{r}
anova(lm_mr_only_sex, lm_mr_contr_motion_no_sex)
```

The model with the smaller RSS is the one with the vision variables included.

We conclude that vision measures are a better predictor of individual differences in mental rotation scores than sex.




## Do outliers account for results?

The scatterplots indicate that despite the log transformation, there are some individual participants who had especially high thresholds for contrast and motion duration.

Do our results hold when we trim the data to focus on those individuals whose data are within `r params$outlier_sd_thresh` standard deviations of the mean log threshold?

We define a helper function to detect outliers.

```{r}
FindOutliers <- function(data, sd_thresh = as.numeric(params$outlier_sd_thresh)) {
  sd = sd(data, na.rm = T)
  mean = mean(data, na.rm = T)
  # we identify extreme outliers
  extreme.threshold.upper = (sd * sd_thresh) + mean
  extreme.threshold.lower = -(sd * sd_thresh) + mean
  result <-
    which(data > extreme.threshold.upper |
            data < extreme.threshold.lower)
  print(result)
}

#all_outliers <- lapply(sex_diff_df, FindOutliers)
```

### Visual perception thresholds

#### Contrast thresholds

We detect outliers in contrast threshold.

```{r}
FindOutliers(sex_diff_df$log_contrast)
```

No contrast thresholds exceed the criterion.

#### Motion duration thresholds

```{r}
FindOutliers(sex_diff_df$log_motion)
```

Two cases exceed the criterion for motion.

Create a new trimmed data frame.

```{r}
df_trimmed <- sex_diff_df[-c(FindOutliers(sex_diff_df$log_motion)),]
```


```{r}
xtabs(~ Sex, df_trimmed)
```


```{r}
df_trimmed %>%
  ggplot() +
  aes(Sex, log_motion) +
  geom_boxplot()
```

We then test for a difference in means.

```{r}
mdt_tt <-
  t.test(
    log_motion ~ Sex,
    data = df_trimmed,
    var.equal = TRUE,
    alternative = "greater"
  ) # Hypothesized
mdt_tt
```

Women still have larger motion duration threshold than men.

### Mental rotation

```{r}
FindOutliers(sex_diff_df$mental_rot)
```

There were no outliers in mental rotation.

### Vocabulary

```{r}
FindOutliers(sex_diff_df$vocab)
```

There were no outliers in vocabulary.

### Correlations among measures

Since trimming outliers only affected the motion threshold data, we focus on that measure.

```{r}
sex_diff_df_F <- df_trimmed %>%
  dplyr::filter(., Sex == "Female")

sex_diff_df_M <- df_trimmed %>%
  dplyr::filter(., Sex == "Male")
```

#### Motion thresholds and mental rotation

```{r}
cor.test(
  sex_diff_df_F$log_motion,
  sex_diff_df_F$mental_rot,
  method = "pearson",
  alternative = "less"
)
```

Log(motion duration) thresholds (negatively) correlate with mental rotation scores in women, even after trimming. 

```{r}
cor.test(
  sex_diff_df_M$log_motion,
  sex_diff_df_M$mental_rot,
  method = "pearson",
  alternative = "less"
)
```

Motion duration thresholds do not correlate with mental rotation scores in men.

#### Contrast thresholds and motion thresholds

##### Women

```{r}
cor.test(
  sex_diff_df_F$log_contrast,
  sex_diff_df_F$log_motion,
  method = "pearson",
  alternative = "greater"
)
```

The vision measures now correlate in women.

```{r}
es_contrast_motion <- esci::estimateCorrelation.default(sex_diff_df_F, log_contrast, log_motion)
#es_contrast_motion
```

We find that a correlation between log contrast and log motion thresholds in women is as follows: `r es_contrast_motion$formatted_r`.

##### Men

```{r}
cor.test(
  sex_diff_df_M$log_contrast,
  sex_diff_df_M$log_motion,
  method = "pearson",
  alternative = "greater"
)
```

The vision measures still correlate in men.

### Model-based approach

Do the trimmed data show a stronger relationship between vision and mental rotation than sex and mental rotation?

```{r}
df_mr_contr_motion <- df_trimmed %>%
  dplyr::select(., Sex, log_contrast, log_motion, mental_rot) %>%
  dplyr::filter(., !is.na(Sex),
                !is.na(log_contrast),
                !is.na(log_motion),
                !is.na(mental_rot))
```

Vision plus sex.

```{r}
lm_mr_contr_motion_no_interactions <- lm(mental_rot ~ log_contrast + log_motion + Sex, data = df_mr_contr_motion)
summary(lm_mr_contr_motion_no_interactions)
car::Anova(lm_mr_contr_motion_no_interactions)
confint(lm_mr_contr_motion_no_interactions)
lsr::etaSquared(lm_mr_contr_motion_no_interactions)
```

Vision alone.

```{r}
lm_mr_contr_motion_no_sex <- lm(mental_rot ~ log_contrast + log_motion, data = df_mr_contr_motion)
summary(lm_mr_contr_motion_no_sex)
car::Anova(lm_mr_contr_motion_no_sex)
confint(lm_mr_contr_motion_no_sex)
lsr::etaSquared(lm_mr_contr_motion_no_sex)
```

Compare models.

```{r}
anova(lm_mr_contr_motion_no_sex, lm_mr_contr_motion_no_interactions)
```

So, the RSS drops a bit, but not significantly. All things being equal, we'd choose the simpler model for parsimony reasons.

Here's a model with sex alone.

```{r}
lm_mr_only_sex <- lm(mental_rot ~ Sex, data = df_mr_contr_motion)
summary(lm_mr_only_sex)
```

Comparing this to one with vision but not sex.

```{r}
anova(lm_mr_only_sex, lm_mr_contr_motion_no_sex)
```

The model with the smaller RSS is the one with the vision variables included.

We still conclude that vision measures are a better predictor of individual differences in mental rotation scores than sex.


## Does interest in specific male-typed hobbies correlate with vision?

Determine which hobbies are strongly male-typed according to (CITE):

- Golf
- Home eletronics
- Surfing
- Computers
- Video games
- Watching violent movies
- Going to car shows
- Fishing
- Poker
- Playing Basketball
- TV sports
- Football
- Weight lifting
- Working on cars
- Drag racing

```{r}
var <-
  c(
    "Participant",
    "Sex",
    "log_contrast",
    "log_motion",
    "Golf",
    "Home electronics",
    "Surfing",
    "Computers",
    "Video games",
    "Watching violent movies",
    "Going to car shows",
    "Fishing",
    "Poker",
    "Playing basketball",
    "TV sports",
    "Football",
    "Weight lifting",
    "Working on cars",
    "Drag racing",
    "Masculine_hobbies"
  )
male_hobbies <- sex_diff_df[, var]
male_hobbies_F <- male_hobbies %>% 
  dplyr::filter(Sex == "Female")
```

### Calculate alpha

```{r}
psych::alpha(male_hobbies[,-c(1:4,20)])
```

### Check data for outliers

```{r}
FindOutliers(male_hobbies$Masculine_hobbies)
```

No data are outliers.

### Correlation between male-typed hobbies and log contrast

```{r}
rcorr(as.matrix(male_hobbies_F[,-c(1,2,4)]))$P[,1] # home electronics and basketball
rcorr(as.matrix(male_hobbies_F[,-c(1,2,4)]))$r[,1]
```

`Playing basketball` and `Home electronics` substantial large negative correlations (in women) with log contrast thresholds.

#### Playing basketball and Contrast Sensitivity

```{r}
cor.test(
  male_hobbies_F$log_contrast,
  male_hobbies_F$"Playing basketball",
  method = "pearson",
  alternative = "two.sided"
)

es_mental_mas_contrast <- esci::estimateCorrelation.default(male_hobbies_F, log_contrast, "Playing basketball")
es_mental_mas_contrast$formatted_r
```

#### Home electronics and Contrast Sensitivity

```{r}
cor.test(
   male_hobbies_F$log_contrast,
   male_hobbies_F$"Home electronics",
  method = "pearson",
  alternative = "two.sided"
)

es_mental_mas_contrast <- esci::estimateCorrelation.default( male_hobbies_F, log_contrast, "Home electronics")
es_mental_mas_contrast$formatted_r
```


### Correlation between male-typed hobbies and log motion

```{r}
rcorr(as.matrix(male_hobbies_F[,-c(1:3)]))$P[,1] # computer, camping, weight lifting
rcorr(as.matrix(male_hobbies_F[,-c(1:3)]))$r[,1]
```

`Weightlifing` and `Computers` shows substantial correlations with motion duration thresholds.

#### Weightlifting and Motion Duration

```{r}
cor.test(
   male_hobbies_F$log_motion,
   male_hobbies_F$"Weight lifting",
  method = "pearson",
  alternative = "two.sided"
)

es_mental_mas_contrast <- esci::estimateCorrelation.default( male_hobbies_F, log_motion, "Weight lifting")
es_mental_mas_contrast$formatted_r
```

##### Computers and Motion Duration

```{r}
cor.test(
   male_hobbies_F$log_motion,
   male_hobbies_F$"Computers",
  method = "pearson",
  alternative = "two.sided"
)

es_mental_mas_contrast <- esci::estimateCorrelation.default( male_hobbies_F, log_motion, "Computers")
es_mental_mas_contrast$formatted_r
```

<<<<<<< HEAD
### set function for scatterplot
```{r}
sex_diff_scatter3 <-
  function(df,
           x_var,
           y_var,
           x_lab = "X axis",
           y_lab = "Y axis"
           ) {
    require(tidyverse)
    require(ggExtra)
    
    x_var_s <- sym(x_var)
    y_var_s <- sym(y_var)
    
    p <- ggplot(df) +
      aes(
        x = !!x_var_s,
        y = !!y_var_s
      ) +
      geom_point(size=4) +
      xlab(x_var) +
      ylab(y_var) +
      stat_smooth(method = "lm", na.rm = TRUE) +
      xlab(x_lab) +
      ylab(y_lab)+
      theme.custom +
      ylim(1, 5) 
p
  }
```

#### get scatterplot for contrast sensitivity and playing basketball
```{r}
sex_diff_scatter3(
  male_hobbies_F,
  "log_contrast",
  "Playing basketball",
  "log(contrast threshold)",
  "Playing basketball"
)
```
#### get scatterplot for contrast sensitivity and electronics
```{r}
sex_diff_scatter3(
  male_hobbies_F,
  "log_contrast",
  "Home electronics",
  "log(contrast threshold)",
  "Home electronics"
)
```
#### get scatterplot for motion sensitivity and weight lifting
```{r}
sex_diff_scatter3(
  male_hobbies_F,
  "log_motion",
  "Weight lifting",
  "log(motion threshold)",
  "Weight lifting"
)
```
#### get scatterplot for motion sensitivity and weight lifting, after excluding outliers
```{r}
male_hobbies_Fex<-male_hobbies_F[-which(male_hobbies_F$log_motion > -1),]
sex_diff_scatter3(
  male_hobbies_Fex,
  "log_motion",
  "Weight lifting",
  "log(motion threshold)",
  "Weight lifting"
)
```

#### get scatterplot for motion sensitivity and weight lifting
```{r}
sex_diff_scatter3(
  male_hobbies_F,
  "log_motion",
  "Computers",
  "log(motion threshold)",
  "Computers"
)
=======


## Do men and women differ in other ways?

### Age

```{r, age}
xtabs(~ Sex + Age, df_trimmed)
```

### School_year

```{r, school_year}
xtabs(~ Sex + School_year, df_trimmed)
```

### Visual acuity

```{r, acuity}
xtabs(~ Sex + Acuity, df_trimmed)
```

### Stereo acuity

```{r, stereo}
xtabs(~ Sex + Stereo_amin, df_trimmed)
>>>>>>> 11488e57d5cb64f5d3e68ab9abf4bfd893910f29
```

